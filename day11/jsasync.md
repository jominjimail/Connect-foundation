# 4. 글쓰기, 정리

자바스크립트 비동기에 대해서 이해하기 위해서, **call stack과 event queue, event loop**에 대해서 글로 정리한다.

## 비동기와 동기란

### 비동기

- Asynchronous : B가 (A가 B에게 보낸)요청에 따른 응답을 전해주지 않아도 A는 다른 작업을 처리 가능하다.
- 예시) 편지나 전화를 들수 있다. A가 B에게 편지를 보낸다. B는 A가 편지를 보내든 말든 할일을 하다가 편지가 오면 어? 편지왔네하고 알아차린다. 
- 예시) 홈페이지에 접속했는데 이미지가 로딩중이다 하지만 나는 버튼을 클릭할 수 있다. 페이지 로딩 시 데이터를 별도로 가져오는 기술이라고 할 수 있다. 
- 일반적으로 시간이 오래걸리는 작업들을 다룰때 사용한다. 데이터를 읽는것은 하드웨어작업이다. (굉장히 느리다) 그에 비해 cpu의 처리속도는 굉장히 빠르다. 빠른 cpu가 데이터를 기다리느라 탱자탱자 놀고 있으면 비효율적이므로 이러한 문제를 해결하고자 비동기라는 개념이 등장하였다.
  - 파일 입출력
  - 소켓프로그래밍 I/O
- 비동기 프로그래밍 : 연산을 요청후 결과를 기다리지 않고 다른 작업을 수행한다. 하지만, 요청한 결과가 언제 끝났는지 알수가 없다. 그래서 다음 개념이 등장한다.
  - 비동기 I/O : I/O을 요청한 후에 결과를 기다리지 않고 다른연산을 하다가 나중에 앞서 요청한 I/O의 결과를 확인하는 방식이다. 
  - Polling : I/O 요청후에 애플리케이션이 알아서 일정한 시간이 지난후에 I/O가 끝났는지 물어보는 방식이다. 화장실 문을 계속 두드리는것이다.
  - 시그널 / 콜백함수 : 유닉스 계열은 I/O를 비동기로 요청하고 I/O가 끝나면 시그널을 발생시켜 I/O의 종료 사실을 알린다. MAX/WIN 계열에서는 콜백함수를 사용한다. 근본적으로 시그널과 큰 차이는 없지만, 시그널은 시그널당 한개의 핸들러만 가능하고 콜백함수는 I/O 요청마다 별도의 콜백함수를 지정할 수 있다. 

### 동기

- Synchronous : B가 요청에 따른 응답을 전해줘야 A가 일을 할 수 있다. 즉, 요청에 따른 응답이 동시에 일어난다.

- 예시) 은행 시스템 : 한 사람이 ATM기기에서 돈을 출금했는데, 그 계좌 잔고의 변화가 즉각 갱신이 일어나지 않으면 이것이 조금씩 커져 결국 전체 시스템의 문제가 된다. 

- 동기 프로그래밍 : 시간이 얼마나 걸리든 기다린다. 순차적이고 우리가 이해하기 쉽다.

  

### 자바스크립트 비동기 

- js 가 비동기 처리를 하는 이유 : 특정코드의 연산이 끝날때까지 기다리지 않고 다음코드를 먼저 실행시키기 위해서이다.
- 비동기 처리 예시 ) JQuery의 ajax 보통 화면에 표시할 이미지나 데이터를 서버에서 불러와 표시한다. 이때 오래걸릴수 있기때문에 비동기 처리를 한다.
- 비동기 처리 예시 ) setTimeout()은 Web API의 한 종류이다. 코드를 바로 실행하지 않고 지정한 시간만큼 기다렸다가 로직을 실행한다. 

### 자바스크립트 CallStack 이해하기

- .js 파일은 js 엔진을 사용한다. 가장 대중적인 엔진은 구글의 V8엔진이다. 이 엔진 안에는 memory heap, callstack이 들어있다. 

  - Memory Heap : 변수나 객체들의 메모리를 할당해준다.
  - CallStack : 코드가 실행되면 호출 스택이 차곡차곡 쌓인다.

- .js 파일의 실행환경에 엔진만 있는것이 아니다. js 엔진 + Web APIs 와 Web API의 호출을 통제하기 위한 CallbackQueue 와 EventLoop등이 있다. 

- js 는 단일 thread 프로그래밍이므로 단일 호출 스택을 사용하고 이말은 한번에 하나의 task만 처리가능하다는 말이다. 멀티 thread에서 발생하는 복잡한 issue들을 고려할 필요 없어 굉장히 쉽다. 하지만, 문제점이 있다.

  - 문제점 : 굉장히 제한적이다. 스택이 하나라 실행하고 있는 맨 위 함수가 굉장히 느리다면 코드는 blocking 이 된다. 굉장히 느리다는 의미이다. 
  - 해결 방법 : Asynchronous callback을 사용하면 된다.

  

### 자바스크립트 이벤트 큐 이해하기

- 예시를 들어보자. 호출스택에 setTimeout()이 나타났다가 바로 사라진다. 이 함수는 비동기 처리가 되서 그렇다. 실제로 WebAPI로 타이머가 동작하게되고 일정 시간이 지나면 이벤트 큐에 차례대로 들어가게된다. 여기서 이벤트 루프의 역할이 나오게 된다.

### 자바스크립트 이벤트 루프 이해하기

- 이벤트 루프는 콜 스택을 주시한다. 계속 주시하다가 스택이 비어있는 상태가 됐을때! 이벤트 큐에 있던 task를 차례대로 스택에 쌓아준다. 그럼 우리가 느끼기에는 일정시간뒤에 갑자기 실행된것처럼 보인다. 마치 비동기 함수가 동작하는것 처럼 보이게된다. 

참고

[자바스크립트 비동기](<https://joshua1988.github.io/web-development/javascript/javascript-asynchronous-operation/>)

[자바스크립트 CallStack 이해하기](<https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf>)